<script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/widgets/Sketch",
    "esri/layers/GraphicsLayer"
  ], function(Map, MapView, Sketch, GraphicsLayer) {
    const graphicsLayer = new GraphicsLayer();

    const map = new Map({
      basemap: "topo-vector",
      layers: [graphicsLayer]
    });

    const view = new MapView({
      container: "viewDiv",
      map: map,
      center: [31.8, 30.4],  // Default center
      zoom: 8
    });

    const sketch = new Sketch({
      layer: graphicsLayer,
      view: view,
      creationMode: "update",
      availableCreateTools: ["point"],
      container: "sketchDiv"
    });

    sketch.on("create", function(event) {
      if (event.state === "complete") {
        const geometry = event.graphic.geometry;
        const lon = geometry.longitude;
        const lat = geometry.latitude;

        // Send selected coordinates back to Joget form
        window.parent.postMessage(
          {
            type: "coordinateSelected",
            coordinates: `${lat.toFixed(6)}, ${lon.toFixed(6)}`
          },
          "*"
        );
      }
    });
  });
</script>

